# MySql

## 什么是MySql

MySQL 是最流行的关系型数据库管理系统，在 WEB 应用方面 MySQL 是最好的 RDBMS(Relational Database Management System：关系数据库管理系统)应用软件之一。 

## 存储引擎

通过下面的命令查看默认的存储引擎：`mysql> show variables like '%storage_engine%';`

查看表的存储引擎:`show table status like "table_name" ;`

MyISAM和InnoDB区别:

1. InnoDB支持事务，MyISAM不支持，对于InnoDB每一条SQL语言都默认封装成事务，自动提交，这样会影响速度，所以最好把多条SQL语言放在begin和commit之间，组成一个事务； 

2. InnoDB支持外键，而MyISAM不支持。对一个包含外键的InnoDB表转为MYISAM会失败； 

3. InnoDB支持表、行(默认)级锁，而MyISAM支持表级锁；

4. InnoDB是聚集索引，使用B+Tree作为索引结构，数据文件是和（主键）索引绑在一起的（表数据文件本身就是按B+Tree组织的一个索引结构），必须要有主键，通过主键索引效率很高。但是辅助索引需要两次查询，先查询到主键，然后再通过主键查询到数据。因此，主键不应该过大，因为主键太大，其他索引也都会很大。

MyISAM是非聚集索引，也是使用B+Tree作为索引结构，索引和数据文件是分离的，索引保存的是数据文件的指针。主键索引和辅助索引是独立的。

也就是说：InnoDB的B+树主键索引的叶子节点就是数据文件，辅助索引的叶子节点是主键的值；而MyISAM的B+树主键索引和辅助索引的叶子节点都是数据文件的地址指针。

5. InnoDB表必须有主键（用户没有指定的话会自己找或生产一个主键），而MyISAM可以没有；

InnoDB为什么推荐使用自增ID作为主键？

自增ID可以保证每次插入时B+索引是从右边扩展的，可以避免B+树和频繁合并和分裂（对比使用UUID）。如果使用字符串主键和随机主键，会使得数据随机插入，效率比较差。

## 事务

事务是逻辑上的一组操作，要么都执行，要么都不执行。

事务的四大特性：

1. **原子性（Atomicity）：** 事务是最小的执行单位，不允许分割。事务的原子性确保动作要么全部完成，要么完全不起作用；
2. **一致性（Consistency）：** 执行事务前后，数据保持一致，多个事务对同一个数据读取的结果是相同的；
3. **隔离性（Isolation）：** 并发访问数据库时，一个用户的事务不被其他事务所干扰，各并发事务之间数据库是独立的；
4. **持久性（Durability）：** 一个事务被提交之后。它对数据库中数据的改变是持久的，即使数据库发生故障也不应该对其有任何影响。

并发读问题：

- **脏读（Dirty read）:** 当一个事务正在访问数据并且对数据进行了修改，而这种修改还没有提交到数据库中，这时另外一个事务也访问了这个数据，然后使用了这个数据。因为这个数据是还没有提交的数据，那么另外一个事务读到的这个数据是“脏数据”，依据“脏数据”所做的操作可能是不正确的。

  读到了另一事务未提交更新数据，即读取到了脏数据。

- **不可重复读（Unrepeatableread）:** 指在一个事务内多次读同一数据。在这个事务还没有结束时，另一个事务也访问该数据。那么，在第一个事务中的两次读数据之间，由于第二个事务的修改导致第一个事务两次读取的数据可能不太一样。这就发生了在一个事务内两次读到的数据是不一样的情况，因此称为不可重复读。

  对同一记录的两次读取不一致哦，因为另一事务对该记录做了修改。

- **幻读（Phantom read）:** 幻读与不可重复读类似。它发生在一个事务（T1）读取了几行数据，接着另一个并发事务（T2）插入了一些数据时。在随后的查询中，第一个事务（T1）就会发现多了一些原本不存在的记录，就好像发生了幻觉一样，所以称为幻读。

  对同一张表的两次查询不一致，因为另一事务插入了一条记录。

查看MySql的隔离级别：`show variables like '%isolation';`

事务的四大隔离级别：

* SERIALIZABLE(串行化)
* REPEATABLE READ(可重复读)
* READ COMMITTED(读已提交的数据)
* READ UNCOMMITTED(读未提交的数据)

MySql默认的隔离级别是：可重复读

| 隔离级别         | 脏读 | 不可重复读 | 幻读 |
| ---------------- | ---- | ---------- | ---- |
| READ-UNCOMMITTED | √    | √          | √    |
| READ-COMMITTED   | ×    | √          | √    |
| REPEATABLE-READ  | ×    | ×          | √    |
| SERIALIZABLE     | ×    | ×          | ×    |

## Mysql逻辑架构

![](https://cdn.jsdelivr.net/gh/12581a/cdn/images/MySql1.png)

MySQL逻辑架构整体分为三层，最上层为客户端层，并非MySQL所独有，诸如：连接处理、授权认证、安全等功能均在这一层处理。

MySQL大多数核心服务均在中间这一层，包括查询解析、分析、优化、缓存、内置函数(比如：时间、数学、加密等函数)。所有的跨存储引擎的功能也在这一层实现：存储过程、触发器、视图等。

最下层为存储引擎，其负责MySQL中的数据存储和提取。和Linux下的文件系统类似，每种存储引擎都有其优势和劣势。中间的服务层通过API与存储引擎通信，这些API接口屏蔽了不同存储引擎间的差异。

每一个客户端发起一个新的请求都由服务器端的连接/线程处理工具负责接收客户端的请求并开辟一个新的内存空间，在服务器端的内存中生成一个新的线程，当每一个用户连接到服务器端的时候就会在进程地址空间里生成一个新的线程用于响应客户端请求，用户发起的查询请求都在线程空间内运行， 结果也在这里面缓存并返回给服务器端。线程的重用和销毁都是由连接/线程处理管理器实现的。

综上所述：用户发起请求，连接/线程处理器开辟内存空间，开始提供查询的机制。

##　MySQL查询过程

用户总是希望MySQL能够获得更高的查询性能，最好的办法是弄清楚MySQL是如何优化和执行查询的。一旦理解了这一点，就会发现：很多的查询优化工作实际上就是遵循一些原则让MySQL的优化器能够按照预想的合理方式运行而已。

当向MySQL发送一个请求的时候，MySQL到底做了些什么呢？下图展示了MySQL的查询过程。

![](https://cdn.jsdelivr.net/gh/12581a/cdn/images/MySql2.png)



MySQL整个查询执行过程，总的来说分为6个步骤：

1. 客户端向MySQL服务器发送一条查询请求
2. 服务器首先检查查询缓存，如果命中缓存，则立刻返回存储在缓存中的结果。否则进入下一阶段
3. 服务器进行SQL解析、预处理、再由优化器生成对应的执行计划
4. MySQL根据执行计划，调用存储引擎的API来执行查询
5. 将结果返回给客户端，同时缓存查询结果

## 索引

索引是帮助MySQL高效获取数据的排好序的数据结构。

使用索引的优点：

大大减小了服务器需要扫描到的数据量

可以帮助服务器避免排序和临时表

可以将随机I/O变为顺序I/O

**索引分类**：

普通索引

主键索引

唯一索引

全文索引

组合索引

**B+树结构：**

非叶子节点不存储data，只存储索引，每个索引页的大小约为16kb,可以存放1000多个索引，叶子节点包含所有的索引字段，叶子节点用指针连接，提高区间访问的性能。

MyISAM存储引擎：它的数据库文件有三个 .frm文件、.data文件、index文件

InnoDB:它的数据库文件有两个.frm、ibd文件

![](D:\TyporaFile\图片\MyISAM.PNG)

![](D:\TyporaFile\图片\InnoDB.PNG)

B+树的指针会维护下一个数据节点的地址，使用范围查询时，比如说查询>20的数据，当查找到20这个节点的数据时，会把后面的直接加载到内存中，大大的提高了效率。

**聚集索引和非聚集索引**

聚簇索引：聚簇索引并不是一种单独的索引类型，而是一种数据存储方式，当表有聚簇索引时，它的数据行实际存放在索引的叶子页中，将数据存储与索引放到了一块，找到索引也就找到了数据

非聚簇索引：将数据存储于索引分开结构，索引结构的叶子节点指向了数据的对应行，myisam通过key_buffer把索引先缓存到内存中，当需要访问数据时（通过索引访问数据），在内存中直接搜索索引，然后通过索引找到磁盘相应数据，这也就是为什么索引不在key buffer命中时，速度慢的原因。

**索引优化：**

索引覆盖： 只需要在一棵索引树上就能获取SQL所需的所有列数据，无需回表，速度更快。 

普通索引（二级索引），非聚簇索引，其叶子节点存储的是聚簇索引的的值

回表查询：先通过普通索引的值定位聚簇索引值，再通过聚簇索引的值定位行记录数据，需要扫描两次索引B+树，它的性能较扫一遍索引树更低。

## explain

查看执行计划

<img src="D:\TyporaFile\技术栈\后端\assets\微信图片_20220210171425.jpg" style="zoom: 25%;" />

[博文链接](https://blog.csdn.net/lvhaizhen/article/details/90763799)

## 主从复制



























